# 音频整理应用 - 技术架构与实现状态

## 目标
构建一个高性能 Rust 应用程序，用于整理音频文件，处理翻唱（Cover）歌曲，获取原始媒体元数据，并通过音频指纹支持在线搜索。目前已实现核心功能，并正在扩展以支持**Web 端实时扫描监控**、**资源使用跟踪**、**重复文件检测**以及**旋律相似度匹配/推荐**。

## 关键技术与实现

### 1. 音频指纹 (已实现)
*   **库**: `chromaprint-rust` / `symphonia` (用于解码)。
*   **服务**: **AcoustID**。
*   **机制**:
    1.  使用 `symphonia` 高效解码音频文件。
    2.  生成指纹并结合时长数据。
    3.  查询 AcoustID API 获取 `Recording ID`。
*   **状态**: 核心指纹生成与查找逻辑已集成。

### 2. 元数据获取 (已实现)
*   **客户端**: `reqwest` (阻塞模式用于 Rayon 线程池)。
*   **来源**: **MusicBrainz**。
*   **机制**:
    1.  通过 AcoustID 结果关联到 MusicBrainz Recording。
    2.  递归查询 Relations (`Recording` -> `Work` -> `Recording`) 以识别原唱。
*   **状态**: 支持复杂的元数据关联和原唱查找。

### 3. 文件处理与并发 (已实现)
*   **并发库**: `rayon`。
*   **机制**:
    *   **Diff 阶段**: 串行快速扫描文件系统 (mtime/size) 并与本地 `index.json` 对比。
    *   **处理阶段**: 使用 `rayon::par_iter` 并行处理新增或修改的文件。
*   **状态**: 多线程扫描已投入生产。

### 4. 音频文件标签 (已实现)
*   **库**: `lofty`。
*   **功能**: 
    *   作为在线查找失败时的回退数据源。
    *   支持离线模式下的纯标签整理。

### 5. Web 仪表盘 (增强中)
*   **框架**: `axum` + `Vue.js`。
*   **新功能**:
    *   **实时扫描监控**: 通过 API 轮询或 SSE 获取扫描进度和当前正在处理的文件。
    *   **资源监控**: 显示服务器 CPU 和 内存使用率。
    *   **扫描控制**: 直接从 Web 界面触发扫描任务。
    *   **重复文件管理**: 展示基于音频指纹的重复文件组。

### 6. 旋律指纹与相似度匹配 (新增确立)
*   **库**: `bliss-audio`.
*   **配置**: 启用 `symphonia` feature，禁用默认的 `ffmpeg`。
*   **存储方案**: **内存加载 + 二进制持久化**。
    *   **持久化**: 使用 `bincode` 存储为 `analysis.bin`。
    *   **运行时**: 启动时全量加载至内存 `HashMap`。

#### 存储方案对比分析
| 方案 | 加载/写入性能 | 查询速度 (N=50k) | 内存占用 | 复杂度 | Windows 部署 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **A. 二进制 (`bincode`) + 内存计算** | **极快** (几十毫秒) | **极快** (内存线性扫描，< 10ms) | **低** (~8MB) | **低** (无需 SQL) | **优** (无 DLL) |
| **B. 普通数据库 (SQLite)** | 中等 | **慢** (需读出所有行再计算，或使用复杂 SQL) | 低 (按页加载) | 中 | 良 (需 DLL) |
| **C. 向量数据库 (SQLite+VSS)** | 中等 | 快 (索引搜索) | 中 | **高** (需特定扩展) | **差** (配置繁琐) |

> **结论**: 对于本地音乐库（通常 < 10万首），方案 A 在性能和工程复杂度上具有绝对优势。
> *   **内存计算**: 5万首歌的特征向量 (40维 float) 仅占用约 8MB 内存。Rust 在内存中遍历并计算欧氏距离的速度远超数据库 IO。
> *   **工程化**: 避免了在 Windows 上分发 SQLite DLL 或配置复杂的向量搜索扩展 (`sqlite-vss`)。

## 新增架构组件 (计划中) (保持不变)
（略... 参见上文）

## 工作流 (保持不变)
（略... 参见上文）
